{% extends "member/base.html" %}
{% block title %}ë‚™ìƒ ê°ì§€ ì‹œìŠ¤í…œ{% endblock %}

{% block content %}
<h2>ë‚™ìƒ ê°ì§€ ì‹œìŠ¤í…œ</h2>

<div style="display: flex; gap: 20px;">
  <!-- ğŸ“· ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¼ + ë²„íŠ¼ -->
  <div id="camera-wrapper" style="position: relative; width: 800px; height: 500px; background: black;">
    <img
      id="pose-stream"
      src="{% url 'pose_estimation_feed' %}"
      style="width: 100%; height: 100%; object-fit: cover"
    />

    <!-- ğŸ”² ê²€ì •ìƒ‰ ì˜¤ë²„ë ˆì´ (í™”ë©´ë§Œ ê°€ë¦¼) -->
    <div id="black-overlay" style="
      display: none;
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: black;
      opacity: 0.85;
      z-index: 10;
    "></div>

    <!-- ë³´í˜¸ëª¨ë“œ ë²„íŠ¼ -->
    <button id="privacy-btn" style="
      position: absolute;
      top: 10px;
      left: 10px;
      padding: 6px 10px;
      font-size: 12px;
      background: purple;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      z-index: 11;
    ">
      ë³´í˜¸ëª¨ë“œ
    </button>

    <!-- í…ŒìŠ¤íŠ¸ ì•Œë¦¼ ë²„íŠ¼ -->
    <button id="alert-btn" style="
      position: absolute;
      top: 10px;
      right: 10px;
      padding: 6px 10px;
      font-size: 12px;
      background: orange;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      z-index: 11;
    ">
      í…ŒìŠ¤íŠ¸ ì•Œë¦¼
    </button>
  </div>

  <!-- ğŸ§  ë‚™ìƒ ìƒíƒœ í‘œì‹œ -->
  <div style="width: 300px;">
    <h3>ë‚™ìƒ ê°ì§€ ìƒíƒœ</h3>
    <div id="fall-status" style="font-size: 20px; font-weight: bold; color: green;">
      ì •ìƒì…ë‹ˆë‹¤
    </div>
  </div>
</div>

<!-- toastr ì•Œë¦¼ CDN -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" rel="stylesheet" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

<script>
  toastr.options = {
    closeButton: true,
    progressBar: true,
    positionClass: "toast-top-right",
    timeOut: "1500",
  };

  const overlay = document.getElementById("black-overlay");
  const statusBox = document.getElementById("fall-status");

  // âœ… ë³´í˜¸ëª¨ë“œ í† ê¸€
  document.getElementById("privacy-btn").addEventListener("click", function () {
    fetch("{% url 'toggle_privacy_mode' %}")
      .then((res) => res.json())
      .then((data) => {
        if (data.privacy_mode) {
          overlay.style.display = "block";
          toastr.success("ğŸ”’ ë³´í˜¸ëª¨ë“œ í™œì„±í™”");
        } else {
          overlay.style.display = "none";
          toastr.info("ğŸ”“ ë³´í˜¸ëª¨ë“œ í•´ì œ");
        }
      });
  });

  // âœ… í…ŒìŠ¤íŠ¸ ë‚™ìƒ ì•Œë¦¼
  document.getElementById("alert-btn").addEventListener("click", function () {
    fetch("{% url 'test_fall_alert' %}", {
      method: "POST",
      headers: {
        "X-CSRFToken": "{{ csrf_token }}",
      },
    })
    .then((res) => res.json())
    .then((data) => {
      toastr.warning("ğŸ“¢ " + data.status);
    });
  });

  // âœ… ì‹¤ì‹œê°„ ë‚™ìƒ ê°ì§€ ìƒíƒœ ê°€ì ¸ì˜¤ê¸°
  function pollFallStatus() {
    fetch("/fall/fall_status/")
      .then((res) => res.json())
      .then((data) => {
        statusBox.textContent = data.label;
        statusBox.style.color = data.fall ? "red" : "green";
      });
  }

  setInterval(pollFallStatus, 1000); // 1ì´ˆë§ˆë‹¤ ê°ì§€ ìƒíƒœ ê°±ì‹ 
</script>
{% endblock %}
